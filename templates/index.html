<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ ‚Äî –ö–æ–Ω—Ç—É—Ä</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --bg: #f4f6fb;
            --card: #ffffff;
            --muted: #6c757d;
            --accent: #0d6efd;
        }
        body { background-color: var(--bg); font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#222; }
        .app-shell { min-height:100vh; }
        .left-panel { height:100vh; padding:1.15rem; border-right: 1px solid rgba(0,0,0,0.05); background: linear-gradient(180deg,#ffffff 0%, #fbfdff 100%); }
        .sources-list { margin-top:1rem; }
        .source-row { display:flex; align-items:center; justify-content:space-between; padding:0.45rem 0.25rem; border-radius:8px; }
        .source-row + .source-row { margin-top:0.4rem; }
        .source-meta { display:flex; gap:0.6rem; align-items:center; }
        .small-muted { color:var(--muted); font-size:0.85rem; }

        .center-panel { padding:1.15rem; }
        .filters-panel { background: var(--card); padding: .9rem; border-radius: 12px; box-shadow: 0 6px 18px rgba(13,110,253,0.03); }
        .messages-container { height: calc(100vh - 220px); overflow-y:auto; padding-top:0.5rem; }

        .msg-card { transition: box-shadow 0.18s, transform 0.08s; border: none; border-radius: 12px; overflow: hidden; position:relative; }
        .msg-card:hover { box-shadow: 0 8px 28px rgba(16,24,40,0.06); transform: translateY(-2px); }
        .msg-leftstripe { width:6px; height:100%; position:absolute; left:0; top:0; }
        .msg-body { padding-left:14px; }

        /* Grouped chat card styles */
        .chat-group-card { border-radius:12px; background:#fff; padding:12px; margin-bottom:12px; box-shadow:0 6px 20px rgba(16,24,40,0.04); position:relative; overflow:hidden; }
        .chat-group-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
        .chat-group-meta { font-size:0.9rem; color:#666; }
        .chat-group-body { margin-top:10px; max-height: 360px; overflow: auto; padding-right:6px; }
        .chat-msg { padding:10px;border-radius:8px;margin-bottom:10px;background:#fbfbfd; }
        .chat-msg .from { font-weight:600; font-size:0.92rem; }
        .chat-summary { padding:10px; background:linear-gradient(180deg,#fffaf0,#fff); border-radius:8px; margin-top:8px; color:#333; }
        .chat-controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        .priority-pill { padding:6px 10px; border-radius:999px; font-weight:600; font-size:0.85rem; }
        .pr-5 { background:linear-gradient(90deg,#6b021d,#a61b2a); color:#fff; }
        .pr-4 { background:linear-gradient(90deg,#ffb020,#ff7a18); color:#fff; }
        .pr-3 { background:linear-gradient(90deg,#20c997,#0ea46f); color:#fff; }
        .pr-1-2 { background:linear-gradient(90deg,#c9ced4,#8b949e); color:#111; }


        .priority-5 .msg-leftstripe { background: linear-gradient(180deg,#6b021d,#a61b2a); }
        .priority-4 .msg-leftstripe { background: linear-gradient(180deg,#ffb020,#ff7a18); }
        .priority-3 .msg-leftstripe { background: linear-gradient(180deg,#20c997,#0ea46f); }
        .priority-2 .msg-leftstripe { background: linear-gradient(180deg,#c9ced4,#aab0b6); }
        .priority-1 .msg-leftstripe { background: linear-gradient(180deg,#8b949e,#6f7a85); }

        .source-badge { font-size: 0.76em; padding: 0.25em .45em; border-radius: 6px; background: rgba(0,0,0,0.06); color:#333; }
        .ai-reply-box { background-color: #f0f8ff; padding: 10px; border-radius: 8px; margin-top: 8px; font-size:0.95rem; color:#0b3d91; }

        .right-panel { padding:1.15rem; height:100vh; border-left:1px solid rgba(0,0,0,0.04); background: linear-gradient(180deg,#ffffff 0%, #fbfdff 100%); }
        .analysis-panel { position: sticky; top:20px; display:flex; flex-direction:column; }
        .analysis-root { overflow-y:auto; max-height: calc(100vh - 120px); padding-right:6px; }

        .analysis-block { background: #fff; padding: 0.9rem; border-radius: 10px; box-shadow: 0 6px 16px rgba(16,24,40,0.03); margin-bottom: 12px; transition: box-shadow 0.18s, border 0.18s; }
        .analysis-block.highlight { box-shadow: 0 10px 26px rgba(13,110,253,0.12); border: 1px solid rgba(13,110,253,0.12); }

        .kw { display:inline-block; padding:7px 10px; border-radius:999px; background:rgba(13,110,253,0.08); color:var(--accent); font-size:0.9rem; margin-right:8px; margin-bottom:8px; cursor:pointer; user-select:none; }
        .kw:hover { background:rgba(13,110,253,0.12); transform:translateY(-1px); }
        .kw-chip { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#f7fbff; border:1px solid rgba(13,110,253,0.08); color:var(--accent); cursor:pointer; margin-right:6px; margin-bottom:6px; }
        .kw-chip.active { box-shadow:0 6px 18px rgba(13,110,253,0.06); background:linear-gradient(180deg,#eaf3ff,#ffffff); }

        /* top-topics scroll small area */
        .top-topics { max-height: 28vh; overflow-y: auto; padding-right:6px; }

        .empty-state { color: var(--muted); text-align:center; padding:2rem; }

        /* LEFT: –Æ–¥–∂–∞–π–ª */
        .udjail-card { margin-top:18px; padding:12px; background:linear-gradient(180deg,#fafbfd,#fff); border-radius:10px; border:1px dashed rgba(0,0,0,0.06); color:var(--muted); }
        .udjail-card h6 { margin-bottom:6px; }

        /* small screens */
        @media (max-width: 991px){
            .left-panel { display:none; }
            .right-panel { display:none; }
            .center-panel { padding:0.75rem; }
        }
    </style>
</head>
<body>
    <div class="container-fluid app-shell">
        <div class="row g-0">
            <!-- LEFT: sources + toggles -->
            <div class="col-lg-2 left-panel d-none d-lg-block">
                <h5 class="mb-2">–ò—Å—Ç–æ—á–Ω–∏–∫–∏</h5>
                <div class="small-muted">–í–∫–ª—é—á–∞–π—Ç–µ/–æ—Ç–∫–ª—é—á–∞–π—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ ‚Äî —ç—Ç–æ —Ñ–∏–ª—å—Ç—Ä –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π</div>

                <div id="sources-container" class="sources-list"></div>

                <div class="udjail-card">
                    <h6>–Æ–¥–∂–∞–π–ª <small class="small-muted">(–Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ)</small></h6>
                    <div class="small-muted" style="font-size:0.9rem">–Æ–¥–∂–∞–π–ª ‚Äî —Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏ –∏ –±—ã—Å—Ç—Ä—ã—Ö —Ä–µ—à–µ–Ω–∏–π.</div>
                    <div class="mt-3 d-flex justify-content-between">
                        <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-rocket"></i> –û—Ç–∫—Ä—ã—Ç—å</button>
                        <button class="btn btn-sm btn-link">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
                    </div>
                </div>

                <hr class="my-3">

                <div class="d-flex justify-content-between align-items-center small-muted">
                    <div>–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
                    <div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto-refresh-switch" checked>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CENTER: messages -->
            <div class="col-lg-8 center-panel">
                <div class="mb-3">
                    <div class="filters-panel">
                        <div class="row align-items-center">
                            <div class="col-md-5 mb-2 mb-md-0">
                                <input type="text" class="form-control" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º...">
                            </div>
                            <div class="col-md-3 mb-2 mb-md-0">
                                <select class="form-select" id="priority-filter">
                                    <option value="">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
                                    <option value="1">1 ‚Äî –Ω–µ –≤–∞–∂–Ω–æ</option>
                                    <option value="2">2 ‚Äî –º–∞–ª–æ –≤–∞–∂–Ω–æ</option>
                                    <option value="3">3 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–æ</option>
                                    <option value="4">4 ‚Äî –≤–∞–∂–Ω–æ</option>
                                    <option value="5">5 ‚Äî —Å—Ä–æ—á–Ω–æ</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-2 mb-md-0">
                                <select class="form-select" id="sort-order">
                                    <option value="desc">–ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ</option>
                                    <option value="asc">–°—Ç–∞—Ä—ã–µ –ø–µ—Ä–≤—ã–µ</option>
                                </select>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-sm btn-outline-secondary" id="refresh-btn"><i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="messages-container" class="messages-container"></div>
            </div>

            <!-- RIGHT: AI analysis -->
            <div class="col-lg-2 right-panel d-none d-lg-block">
                <div class="analysis-panel">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div><h6 class="mb-0">–ò–ò ‚Äî –∞–Ω–∞–ª–∏–∑</h6><div class="small-muted">–¢–µ–º—ã –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</div></div>
                        <button class="btn btn-sm btn-primary" id="refresh-analysis"><i class="fas fa-brain"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>

                    <div id="analysis-root" class="analysis-root">
                        <div class="analysis-block small-muted">–ê–Ω–∞–ª–∏–∑ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- bootstrap bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // state
        let enabledSources = new Set();
        let currentPriority = '';
        let currentSearch = '';
        let currentSortOrder = 'desc';
        let autoRefresh = true;
        const REFRESH_INTERVAL_MS = 5000;
        let searchDebounceTimer = null;

        // Helpers
        function saveEnabledSources(){
            localStorage.setItem('enabledSources', JSON.stringify(Array.from(enabledSources)));
        }
        function loadEnabledSources(){
            try {
                const v = JSON.parse(localStorage.getItem('enabledSources') || 'null');
                if(Array.isArray(v)) {
                    enabledSources = new Set(v);
                }
            } catch(e){ enabledSources = new Set(); }
        }

        function setActiveTopic(keyword){
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä
            const searchInput = document.getElementById('search-input');
            searchInput.value = keyword || '';
            currentSearch = keyword || '';
            loadMessages();

            // –ü–æ–º–µ—Ç–∏–º —á–∏–ø—ã –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏
            const root = document.getElementById('analysis-root');
            if(root){
                root.querySelectorAll('.kw-chip').forEach(c => {
                    const k = (c.dataset.keyword || '').trim();
                    if(keyword && k.toLowerCase() === keyword.toLowerCase()){
                        c.classList.add('active');
                    } else {
                        c.classList.remove('active');
                    }
                });

                // –ø–æ–¥—Å–≤–µ—Ç–∏–º –∏ –ø—Ä–æ—Å–∫—Ä–æ–ª–ª–∏–º –ø–æ–¥—Ä–æ–±–Ω—ã–π –±–ª–æ–∫ —Ç–µ–º—ã
                root.querySelectorAll('.analysis-block').forEach(block => {
                    // –∏—â–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–¢–µ–º–∞: {keyword}" –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞
                    const txt = block.innerText || '';
                    if(keyword && txt.toLowerCase().includes(('—Ç–µ–º–∞: ' + keyword).toLowerCase())){
                        block.classList.add('highlight');
                        // –ø–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª
                        block.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // —Å–Ω–∏–º–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(() => block.classList.remove('highlight'), 4000);
                    } else {
                        block.classList.remove('highlight');
                    }
                });
            }
        }

        function updateActiveChipsBySearch(){
            // –ü—Ä–∏ –≤–≤–æ–¥–µ –≤ –ø–æ–∏—Å–∫ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —á–∏–ø—ã (–µ—Å–ª–∏ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
            const keyword = currentSearch && currentSearch.trim();
            const root = document.getElementById('analysis-root');
            if(!root) return;
            if(!keyword){
                root.querySelectorAll('.kw-chip').forEach(c => c.classList.remove('active'));
                root.querySelectorAll('.analysis-block').forEach(b => b.classList.remove('highlight'));
                return;
            }
            root.querySelectorAll('.kw-chip').forEach(c => {
                const k = (c.dataset.keyword || '').trim().toLowerCase();
                // –ø–æ–º–µ—Ç–∏–º –∞–∫—Ç–∏–≤–Ω—ã–º –µ—Å–ª–∏ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
                if(k && keyword.toLowerCase().includes(k) || k === keyword.toLowerCase()){
                    c.classList.add('active');
                } else {
                    c.classList.remove('active');
                }
            });
        }

        // Load sources from server and render toggles
        function loadSources(){
            fetch('/api/sources').then(r => r.json()).then(data => {
                const container = document.getElementById('sources-container');
                container.innerHTML = '';
                loadEnabledSources();

                // default enable all if empty
                if(enabledSources.size === 0){
                    data.forEach(s => enabledSources.add(s.value));
                    saveEnabledSources();
                }

                data.forEach(src => {
                    const row = document.createElement('div');
                    row.className = 'source-row';

                    const meta = document.createElement('div');
                    meta.className = 'source-meta';
                    const icon = document.createElement('i');
                    icon.className = `fas fa-${src.value === 'telegram' ? 'paper-plane' : 'envelope'} fa-lg text-primary`;
                    const title = document.createElement('div');
                    title.innerHTML = `<div style="font-weight:600">${src.name}</div><div class="small-muted" style="font-size:12px">${src.value}</div>`;
                    meta.appendChild(icon);
                    meta.appendChild(title);

                    const control = document.createElement('div');
                    control.innerHTML = `
                        <div class="form-check form-switch">
                          <input class="form-check-input source-switch" type="checkbox" data-source="${src.value}" ${enabledSources.has(src.value) ? 'checked' : ''}>
                        </div>
                    `;

                    row.appendChild(meta);
                    row.appendChild(control);
                    container.appendChild(row);
                });

                document.querySelectorAll('.source-switch').forEach(cb => {
                    cb.addEventListener('change', (e) => {
                        const src = e.target.dataset.source;
                        if(e.target.checked) enabledSources.add(src); else enabledSources.delete(src);
                        saveEnabledSources();
                        loadMessages();
                        loadAnalysis(); // –æ–±–Ω–æ–≤–∏–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –¥–ª—è –≤–∏–¥–∏–º—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                    });
                });
            });
        }

        // –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è loadMessages: —Ä–µ–Ω–¥–µ—Ä –≥—Ä—É–ø–ø, –ø—Ä–∏–≤–∞—Ç–∫–∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ, ai_reply - —Ä–∞—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        function loadMessages(){
            fetch('/api/grouped_messages')
                .then(res => res.json())
                .then(groups => {
                    const container = document.getElementById('messages-container');
                    container.innerHTML = '';

                    if(!groups || groups.length === 0){
                        container.innerHTML = '<div class="empty-state">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                        return;
                    }

                    groups.forEach(g => {
                        const card = document.createElement('div');
                        card.className = 'chat-group-card';

                        // priority class & label
                        let prClass = 'pr-1-2';
                        if (g.priority >= 5) prClass = 'pr-5';
                        else if (g.priority === 4) prClass = 'pr-4';
                        else if (g.priority === 3) prClass = 'pr-3';

                        const headerHTML = `
                            <div class="chat-group-header">
                                <div>
                                    <div style="font-weight:700">${escapeHtml(g.chat_title || ('–ß–∞—Ç ' + (g.chat_id || '‚Äî')))}</div>
                                    <div class="chat-group-meta">${g.is_group ? '–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç' : '–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –¥–∏–∞–ª–æ–≥'} ‚Ä¢ ${g.total_messages} —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                                </div>
                                <div class="chat-controls">
                                    <div class="priority-pill ${prClass}">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${g.priority}</div>
                                    <button class="btn btn-sm btn-outline-primary btn-gen-reply" data-group="${escapeHtml(g.group_key)}">–û—Ç–≤–µ—Ç –ò–ò</button>
                                    <button class="btn btn-sm btn-outline-danger btn-mark-read" data-group="${escapeHtml(g.group_key)}">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ</button>
                                    <button class="btn btn-sm btn-outline-secondary btn-toggle" data-group="${escapeHtml(g.group_key)}">${g.collapsed ? '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å' : '–°–≤–µ—Ä–Ω—É—Ç—å'}</button>
                                </div>
                            </div>
                        `;

                        card.innerHTML = headerHTML;

                        const body = document.createElement('div');
                        body.className = 'chat-group-body';

                        if (g.is_group) {
                            // –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º (—Å –∏–º–µ–Ω–∞–º–∏) ‚Äî –Ω–æ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ
                            if (g.collapsed) {
                                const summaryBox = document.createElement('div');
                                summaryBox.className = 'chat-summary';
                                summaryBox.innerHTML = `<strong>–°–≤–æ–¥–∫–∞:</strong> ${escapeHtml(g.summary || '(–Ω–µ—Ç —Å–≤–æ–¥–∫–∏)')}`;
                                body.appendChild(summaryBox);

                                const msgsWrap = document.createElement('div');
                                msgsWrap.className = 'chat-messages-collapsed';
                                msgsWrap.style.display = 'none';
                                g.messages.forEach(m => {
                                    const mdiv = document.createElement('div');
                                    mdiv.className = 'chat-msg';
                                    const from = m.from_user_name || '‚Äî';
                                    const date = m.date ? new Date(m.date).toLocaleString() : '';
                                    mdiv.innerHTML = `<div class="from">${escapeHtml(from)} <small class="small-muted" style="font-weight:400">${escapeHtml(date)}</small></div>
                                                    <div class="text" style="margin-top:6px; white-space:pre-wrap">${escapeHtml(m.text_content)}</div>`;
                                    msgsWrap.appendChild(mdiv);
                                });
                                body.appendChild(msgsWrap);
                            } else {
                                g.messages.forEach(m => {
                                    const mdiv = document.createElement('div');
                                    mdiv.className = 'chat-msg';
                                    const from = m.from_user_name || '‚Äî';
                                    const date = m.date ? new Date(m.date).toLocaleString() : '';
                                    mdiv.innerHTML = `<div class="from">${escapeHtml(from)} <small class="small-muted" style="font-weight:400">${escapeHtml(date)}</small></div>
                                                    <div class="text" style="margin-top:6px; white-space:pre-wrap">${escapeHtml(m.text_content)}</div>`;
                                    body.appendChild(mdiv);
                                });
                            }
                        } else {
                            // –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –¥–∏–∞–ª–æ–≥: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ –∑–∞—Ç–µ–º –Ω–∞–±–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–∑ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –∏–º–µ–Ω–∏
                            const participant = g.chat_title || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫';
                            const header = document.createElement('div');
                            header.style.fontWeight = '600';
                            header.style.marginBottom = '8px';
                            header.innerHTML = `${escapeHtml(participant)} <span class="small-muted" style="font-weight:400; margin-left:8px;">${g.total_messages} —Å–æ–æ–±—â–µ–Ω–∏–π</span>`;
                            body.appendChild(header);

                            if (g.collapsed) {
                                const summaryBox = document.createElement('div');
                                summaryBox.className = 'chat-summary';
                                summaryBox.innerHTML = `<strong>–°–≤–æ–¥–∫–∞:</strong> ${escapeHtml(g.summary || '(–Ω–µ—Ç —Å–≤–æ–¥–∫–∏)')}`;
                                body.appendChild(summaryBox);

                                const msgsWrap = document.createElement('div');
                                msgsWrap.className = 'chat-messages-collapsed';
                                msgsWrap.style.display = 'none';
                                g.messages.forEach(m => {
                                    const mdiv = document.createElement('div');
                                    mdiv.className = 'chat-msg';
                                    const date = m.date ? new Date(m.date).toLocaleString() : '';
                                    mdiv.innerHTML = `<div class="small-muted" style="font-size:0.85rem">${escapeHtml(date)}</div>
                                                    <div class="text" style="margin-top:6px; white-space:pre-wrap">${escapeHtml(m.text_content)}</div>`;
                                    msgsWrap.appendChild(mdiv);
                                });
                                body.appendChild(msgsWrap);
                            } else {
                                g.messages.forEach(m => {
                                    const mdiv = document.createElement('div');
                                    mdiv.className = 'chat-msg';
                                    const date = m.date ? new Date(m.date).toLocaleString() : '';
                                    mdiv.innerHTML = `<div class="small-muted" style="font-size:0.85rem">${escapeHtml(date)}</div>
                                                    <div class="text" style="margin-top:6px; white-space:pre-wrap">${escapeHtml(m.text_content)}</div>`;
                                    body.appendChild(mdiv);
                                });
                            }
                        }

                        // AI reply area: –ü–û–ö–ê–ó–ê–ù–ê –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        const aiArea = document.createElement('div');
                        aiArea.className = 'mt-2';
                        aiArea.style.display = 'block'; // <-- —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        aiArea.innerHTML = `<div style="padding:10px;border-radius:8px;background:#f0f8ff;"><strong>–û—Ç–≤–µ—Ç –ò–ò (–≥—Ä—É–ø–ø–æ–≤–æ–π):</strong><div class="ai-reply-text" style="margin-top:8px; white-space:pre-wrap">${escapeHtml(g.summary || '')}</div>
                                            <div class="mt-2 text-end"><button class="btn btn-sm btn-primary btn-copy-reply">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div></div>`;

                        card.appendChild(body);
                        card.appendChild(aiArea);
                        container.appendChild(card);

                        // –°–æ–±—ã—Ç–∏—è: toggle, copy, mark read
                        const btnToggle = card.querySelector('.btn-toggle');
                        const msgsCollapsedWrap = card.querySelector('.chat-messages-collapsed');
                        btnToggle.addEventListener('click', () => {
                            if (!msgsCollapsedWrap) {
                                // –µ—Å–ª–∏ –Ω–µ—Ç collapsed-–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è (–º–∞–ª–µ–Ω—å–∫–∏–π —á–∞—Ç), –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤—ã—Å–æ—Ç—É
                                if (body.style.maxHeight && body.style.maxHeight !== 'none') {
                                    body.style.maxHeight = null;
                                    btnToggle.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
                                } else {
                                    body.style.maxHeight = '200px';
                                    btnToggle.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
                                }
                                return;
                            }
                            if (msgsCollapsedWrap.style.display === 'none') {
                                msgsCollapsedWrap.style.display = 'block';
                                btnToggle.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
                            } else {
                                msgsCollapsedWrap.style.display = 'none';
                                btnToggle.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
                            }
                        });

                        const btnGen = card.querySelector('.btn-gen-reply');
                        btnGen.addEventListener('click', () => {
                            // –ü—Ä–æ—Å—Ç–æ —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º/–ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º aiArea (–æ–Ω–∞ —É–∂–µ –≤–∏–¥–∏–º–∞)
                            aiArea.scrollIntoView({behavior: 'smooth', block: 'center'});
                        });

                        const btnCopy = card.querySelector('.btn-copy-reply');
                        btnCopy && btnCopy.addEventListener('click', () => {
                            const txt = card.querySelector('.ai-reply-text').innerText;
                            navigator.clipboard && navigator.clipboard.writeText(txt);
                            alert('–û—Ç–≤–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
                        });

                        const btnRead = card.querySelector('.btn-mark-read');
                        btnRead.addEventListener('click', () => {
                            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã?')) return;
                            const ids = g.messages.map(m => m.id);
                            Promise.all(ids.map(i => fetch(`/api/messages/${i}`, { method: 'DELETE' })))
                                .then(() => {
                                    loadMessages();
                                    loadAnalysis();
                                }).catch(e => {
                                    console.error('delete group error', e);
                                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
                                });
                        });
                    });
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ grouped messages', err);
                    document.getElementById('messages-container').innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                });
        }



        // AI Analysis panel (–ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è html - –≤–µ—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞ —á–∏–ø—ã)
        function loadAnalysis(){
            const root = document.getElementById('analysis-root');
            root.innerHTML = `<div class="analysis-block small-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞...</div>`;

            // –ø–µ—Ä–µ–¥–∞—ë–º –∫–∞–∫–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤–∫–ª—é—á–µ–Ω—ã, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –º–æ–≥ —É—á–∏—Ç—ã–≤–∞—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            const params = new URLSearchParams();
            params.append('sources', JSON.stringify(Array.from(enabledSources)));

            fetch('/api/analysis?' + params.toString())
                .then(r => r.json())
                .then(resp => {
                    root.innerHTML = resp.html || '<div class="analysis-block small-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>';

                    // –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–≤–µ—Å–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —á–∏–ø—ã
                    root.querySelectorAll('.kw-chip').forEach(chip => {
                        chip.addEventListener('click', function(){
                            const kw = this.dataset.keyword || this.textContent.trim();
                            setActiveTopic(kw);
                        });
                    });

                    // –æ–±–Ω–æ–≤–∏–º –∞–∫—Ç–∏–≤–Ω—ã–µ —á–∏–ø—ã —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–µ–∫—É—â–µ–º—É —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É –ø–æ–∏—Å–∫–∞
                    updateActiveChipsBySearch();
                })
                .catch(err => {
                    console.error('analysis error', err);
                    root.innerHTML = `<div class="analysis-block small-muted">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑</div>`;
                });
        }

        // escape
        function escapeHtml(str){
            if(!str) return '';
            return str.replace(/[&<>"'`=\/]/g, function(s){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s]; });
        }

        // listeners
        document.getElementById('priority-filter').addEventListener('change', function(){ currentPriority = this.value; loadMessages(); });
        document.getElementById('search-input').addEventListener('input', function(){
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                currentSearch = this.value;
                loadMessages();
                updateActiveChipsBySearch();
            }, 280);
        });
        document.getElementById('sort-order').addEventListener('change', function(){ currentSortOrder = this.value; loadMessages(); });
        document.getElementById('refresh-btn').addEventListener('click', () => { loadMessages(); loadAnalysis(); });
        document.getElementById('refresh-analysis').addEventListener('click', () => loadAnalysis());
        document.getElementById('auto-refresh-switch').addEventListener('change', (e) => { autoRefresh = e.target.checked; });

        // auto refresh loop
        setInterval(() => {
            if(autoRefresh) {
                loadMessages();
            }
        }, REFRESH_INTERVAL_MS);

        // init
        window.onload = () => {
            loadSources();
            loadMessages();
            loadAnalysis();
        };
    </script>
</body>
</html>
