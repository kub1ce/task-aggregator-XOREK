<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f5f7fa; font-family: 'Segoe UI', sans-serif; }
        .source-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .priority-1 { border-left: 4px solid #6c757d; }
        .priority-2 { border-left: 4px solid #adb5bd; }
        .priority-3 { border-left: 4px solid #20c997; }
        .priority-4 { border-left: 4px solid #ffc107; }
        .priority-5 { border-left: 4px solid #dc3545; }
        .ai-reply-box { background-color: #e7f3ff; padding: 8px; border-radius: 4px; margin-top: 8px; }
        .msg-card { transition: box-shadow 0.2s; border: none; }
        .msg-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .filters-panel { background: white; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .messages-container { height: calc(100vh - 220px); overflow-y: auto; }
        .empty-state { color: #6c757d; text-align: center; padding: 2rem; }
        .chat-title { font-size: 0.9em; color: #6c757d; }
        .from-user-name { font-weight: 600; }
        .source-badge { font-size: 0.75em; padding: 0.25em 0.5em; border-radius: 4px; }
        .group-icon { color: #0d6efd; }
        .email-icon { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-2 bg-light border-end">
                <h5 class="mt-3">–ò—Å—Ç–æ—á–Ω–∏–∫–∏</h5>
                <div id="sources-container"></div>
            </div>

            <div class="col-8 bg-light">
                <!-- === –§–ò–õ–¨–¢–†–´ –°–í–ï–†–•–£ === -->
                <div class="p-3">
                    <div class="filters-panel">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫...">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="priority-filter">
                                    <option value="">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="source-filter">
                                    <option value="">–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="sort-order">
                                    <option value="desc">–ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ</option>
                                    <option value="asc">–°—Ç–∞—Ä—ã–µ –ø–µ—Ä–≤—ã–µ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="messages-container" class="p-2 messages-container"></div>
            </div>

            <div class="col-2 bg-light"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPriority = '';
        let currentSourceFilter = '';
        let currentSearch = '';
        let currentSortOrder = 'desc';

        function loadSources() {
            fetch('/api/sources')
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('sources-container');
                    container.innerHTML = '';
                    data.forEach(src => {
                        const div = document.createElement('div');
                        div.className = 'source-item';
                        div.innerHTML = `
                            <i class="fas fa-${src.value === 'telegram' ? 'paper-plane' : 'envelope'} me-2"></i>
                            <span class="flex-grow-1">${src.name}</span>
                        `;
                        container.appendChild(div);
                    });
                });
        }

        function loadMessages() {
            const params = new URLSearchParams();
            if (currentPriority) params.append('importance', currentPriority);
            if (currentSourceFilter) params.append('source', currentSourceFilter);
            if (currentSearch) params.append('search', currentSearch);
            params.append('sort_order', currentSortOrder);

            fetch(`/api/messages?${params.toString()}`)
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('messages-container');
                    container.innerHTML = '';

                    if (data.length === 0) {
                        container.innerHTML = '<div class="empty-state">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                        return;
                    }

                    data.sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        return currentSortOrder === 'asc' ? dateA - dateB : dateB - dateA;
                    });

                    data.forEach(msg => {
                        const isGroup = msg.chat_title && msg.chat_title !== msg.from_user_name;
                        const isEmail = msg.source === 'email';

                        const card = document.createElement('div');
                        card.className = `card mb-3 msg-card priority-${msg.importance}`;
                        card.innerHTML = `
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <h6 class="card-subtitle mb-1">
                                        <span class="from-user-name">${isEmail ? (msg.from_user_name || msg.from_email) : (msg.from_user_name || '–ê–Ω–æ–Ω–∏–º')}</span>
                                        ${isGroup ? `<i class="fas fa-users group-icon ms-2" title="–ì—Ä—É–ø–ø–∞"></i>` : ''}
                                        ${isEmail ? `<i class="fas fa-envelope email-icon ms-2" title="–ü–æ—á—Ç–∞"></i>` : ''}
                                    </h6>
                                    <small class="text-muted">${msg.date}</small>
                                </div>
                                ${isEmail ? `<div class="chat-title mb-1"><i class="fas fa-envelope-open-text"></i> ${msg.chat_title}</div>` : (isGroup ? `<div class="chat-title mb-1"><i class="fas fa-comment"></i> ${msg.chat_title}</div>` : '')}
                                <p class="card-text">${msg.text_content}</p>
                                <div class="d-flex justify-content-between text-muted mb-2">
                                    <small class="source-badge bg-secondary">${msg.source}</small>
                                    <small>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${msg.importance}/5</small>
                                </div>
                                ${msg.ai_reply ? `<div class="ai-reply-box"><strong>–û—Ç–≤–µ—Ç –ò–ò:</strong><br>${msg.ai_reply}</div>` : ''}
                                <div class="mt-2">
                                    ${msg.ai_reply ? '' : `<button class="btn btn-sm btn-outline-primary me-2 gen-ai-btn" data-id="${msg.id}">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç</button>`}
                                    <button class="btn btn-sm btn-outline-danger read-btn" data-id="${msg.id}">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ</button>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });

                    document.querySelectorAll('.gen-ai-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.dataset.id;
                            alert('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –¥–ª—è ID: ' + id);
                        });
                    });

                    document.querySelectorAll('.read-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.dataset.id;
                            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                                fetch(`/api/messages/${id}`, { method: 'DELETE' })
                                    .then(() => loadMessages());
                            }
                        });
                    });
                });
        }

        document.getElementById('priority-filter').addEventListener('change', function () {
            currentPriority = this.value;
            loadMessages();
        });
        document.getElementById('source-filter').addEventListener('change', function () {
            currentSourceFilter = this.value;
            loadMessages();
        });
        document.getElementById('search-input').addEventListener('input', function () {
            currentSearch = this.value;
            loadMessages();
        });
        document.getElementById('sort-order').addEventListener('change', function () {
            currentSortOrder = this.value;
            loadMessages();
        });

        setInterval(() => {
            loadMessages();
        }, 500);

        window.onload = () => {
            loadSources();
            loadMessages();
        };
    </script>
</body>
</html>